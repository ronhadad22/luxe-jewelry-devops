name: CI - Build & Push to ECR

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'auth-service/**'
      - 'jewlery-store/**'
      - '.github/workflows/ci-build-push.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'auth-service/**'
      - 'jewlery-store/**'

env:
  AWS_REGION: eu-west-1
  ECR_BACKEND_REPO: luxe-jewelry-dev-backend
  ECR_AUTH_REPO: luxe-jewelry-dev-auth-service
  ECS_CLUSTER: luxe-jewelry-dev-cluster
  ECS_BACKEND_SERVICE: luxe-jewelry-dev-backend
  ECS_AUTH_SERVICE: luxe-jewelry-dev-auth-service
  S3_FRONTEND_BUCKET: luxe-jewelry-dev-frontend
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}

permissions:
  id-token: write
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Detect which services changed
  # ---------------------------------------------------------------------------
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      auth: ${{ steps.filter.outputs.auth }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            auth:
              - 'auth-service/**'
            frontend:
              - 'jewlery-store/**'

  # ---------------------------------------------------------------------------
  # Build & Push Backend
  # ---------------------------------------------------------------------------
  build-backend:
    name: Build Backend
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "image_tag=${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Build, tag, and push backend image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG \
                       -t $ECR_REGISTRY/$ECR_BACKEND_REPO:latest \
                       -t $ECR_REGISTRY/$ECR_BACKEND_REPO:dev \
                       ./backend

          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO --all-tags

      - name: Summary
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          echo "### Backend Image Pushed :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`$IMAGE_TAG\` | \`$ECR_REGISTRY/$ECR_BACKEND_REPO:$IMAGE_TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`latest\` | \`$ECR_REGISTRY/$ECR_BACKEND_REPO:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`dev\` | \`$ECR_REGISTRY/$ECR_BACKEND_REPO:dev\` |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Build & Push Auth Service
  # ---------------------------------------------------------------------------
  build-auth:
    name: Build Auth Service
    needs: changes
    if: needs.changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "image_tag=${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Build, tag, and push auth-service image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_AUTH_REPO:$IMAGE_TAG \
                       -t $ECR_REGISTRY/$ECR_AUTH_REPO:latest \
                       -t $ECR_REGISTRY/$ECR_AUTH_REPO:dev \
                       ./auth-service

          docker push $ECR_REGISTRY/$ECR_AUTH_REPO --all-tags

      - name: Summary
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          echo "### Auth Service Image Pushed :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`$IMAGE_TAG\` | \`$ECR_REGISTRY/$ECR_AUTH_REPO:$IMAGE_TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`latest\` | \`$ECR_REGISTRY/$ECR_AUTH_REPO:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`dev\` | \`$ECR_REGISTRY/$ECR_AUTH_REPO:dev\` |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Build & Deploy Frontend to S3 + CloudFront
  # ---------------------------------------------------------------------------
  build-frontend:
    name: Build & Deploy Frontend
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: jewlery-store/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: jewlery-store

      - name: Build
        run: npm run build
        working-directory: jewlery-store

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync jewlery-store/build/ s3://$S3_FRONTEND_BUCKET \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "service-worker.js"

          aws s3 cp jewlery-store/build/index.html s3://$S3_FRONTEND_BUCKET/index.html \
            --cache-control "no-cache, no-store, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*"

      - name: Summary
        run: |
          echo "### Frontend Deployed to S3 + CloudFront :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 Bucket** | \`$S3_FRONTEND_BUCKET\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **CloudFront** | \`$CLOUDFRONT_DISTRIBUTION_ID\` |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Deploy to ECS (dev) after build
  # ---------------------------------------------------------------------------
  deploy-dev:
    name: Deploy to ECS (dev)
    needs: [build-backend, build-auth, build-frontend]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.build-backend.result == 'success' || needs.build-auth.result == 'success' || needs.build-frontend.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy backend to ECS
        if: needs.build-backend.result == 'success'
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_BACKEND_SERVICE \
            --force-new-deployment

      - name: Deploy auth-service to ECS
        if: needs.build-auth.result == 'success'
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_AUTH_SERVICE \
            --force-new-deployment

      - name: Wait for backend service stability
        if: needs.build-backend.result == 'success'
        run: |
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_BACKEND_SERVICE

      - name: Wait for auth-service stability
        if: needs.build-auth.result == 'success'
        run: |
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_AUTH_SERVICE

      - name: Summary
        run: |
          echo "### Deployment Complete :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "Services updated in cluster \`$ECS_CLUSTER\`" >> $GITHUB_STEP_SUMMARY
