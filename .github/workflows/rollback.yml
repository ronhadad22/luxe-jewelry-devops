name: Rollback

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to rollback'
        required: true
        type: choice
        options:
          - backend
          - auth-service
          - both
      rollback_tag:
        description: 'Image tag to rollback to (e.g. commit SHA)'
        required: true
        type: string
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

env:
  AWS_REGION: eu-west-1
  ECR_BACKEND_REPO: luxe-jewelry-dev-backend
  ECR_AUTH_REPO: luxe-jewelry-dev-auth-service

permissions:
  id-token: write
  contents: read

jobs:
  rollback:
    name: Rollback ${{ inputs.service }} in ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Rollback backend
        if: inputs.service == 'backend' || inputs.service == 'both'
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
        run: |
          echo "Pulling backend:${{ inputs.rollback_tag }}"
          docker pull $ECR_REGISTRY/$ECR_BACKEND_REPO:${{ inputs.rollback_tag }}

          echo "Retagging as ${{ inputs.environment }}"
          docker tag \
            $ECR_REGISTRY/$ECR_BACKEND_REPO:${{ inputs.rollback_tag }} \
            $ECR_REGISTRY/$ECR_BACKEND_REPO:${{ inputs.environment }}
          docker push $ECR_REGISTRY/$ECR_BACKEND_REPO:${{ inputs.environment }}

      - name: Rollback auth-service
        if: inputs.service == 'auth-service' || inputs.service == 'both'
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
        run: |
          echo "Pulling auth-service:${{ inputs.rollback_tag }}"
          docker pull $ECR_REGISTRY/$ECR_AUTH_REPO:${{ inputs.rollback_tag }}

          echo "Retagging as ${{ inputs.environment }}"
          docker tag \
            $ECR_REGISTRY/$ECR_AUTH_REPO:${{ inputs.rollback_tag }} \
            $ECR_REGISTRY/$ECR_AUTH_REPO:${{ inputs.environment }}
          docker push $ECR_REGISTRY/$ECR_AUTH_REPO:${{ inputs.environment }}

      - name: Set ECS names
        id: ecs
        run: |
          ENV="${{ inputs.environment }}"
          echo "cluster=luxe-jewelry-${ENV}-cluster" >> $GITHUB_OUTPUT
          echo "backend_service=luxe-jewelry-${ENV}-backend" >> $GITHUB_OUTPUT
          echo "auth_service=luxe-jewelry-${ENV}-auth-service" >> $GITHUB_OUTPUT

      - name: Force new deployment - backend
        if: inputs.service == 'backend' || inputs.service == 'both'
        run: |
          aws ecs update-service \
            --cluster ${{ steps.ecs.outputs.cluster }} \
            --service ${{ steps.ecs.outputs.backend_service }} \
            --force-new-deployment

      - name: Force new deployment - auth-service
        if: inputs.service == 'auth-service' || inputs.service == 'both'
        run: |
          aws ecs update-service \
            --cluster ${{ steps.ecs.outputs.cluster }} \
            --service ${{ steps.ecs.outputs.auth_service }} \
            --force-new-deployment

      - name: Wait for stability
        run: |
          SERVICES=""
          if [[ "${{ inputs.service }}" == "backend" || "${{ inputs.service }}" == "both" ]]; then
            SERVICES="${{ steps.ecs.outputs.backend_service }}"
          fi
          if [[ "${{ inputs.service }}" == "auth-service" || "${{ inputs.service }}" == "both" ]]; then
            SERVICES="$SERVICES ${{ steps.ecs.outputs.auth_service }}"
          fi

          aws ecs wait services-stable \
            --cluster ${{ steps.ecs.outputs.cluster }} \
            --services $SERVICES

      - name: Summary
        run: |
          echo "### Rollback Complete :rewind:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | \`${{ inputs.service }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Rolled back to** | \`${{ inputs.rollback_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
