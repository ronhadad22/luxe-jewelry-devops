@Library('shared-pipeline-library@main') _

pipeline {
    agent {
        kubernetes {
            yaml FrontendPipeline.getPodTemplate()
        }
    }
    
    environment {
        SERVICE_NAME = 'jewelry-store'
        AWS_DEFAULT_REGION = 'us-east-2'
        ECR_REGISTRY = '950555670656.dkr.ecr.us-east-2.amazonaws.com'
        ECR_REPOSITORY = 'jewleryapp/fe'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Lint & Unit Tests') {
            when {
                expression {
                    FrontendPipeline.isPullRequest(env) ||
                    FrontendPipeline.isMainBranch(env) ||
                    (env.BRANCH_NAME ==~ /^feature\/.*/) ||
                    (env.BRANCH_NAME ==~ /^frontend\/.*/) ||
                    (env.BRANCH_NAME ==~ /^patch\/.*/) ||
                    (env.BRANCH_NAME ==~ /^hotfix\/.*/) ||
                    (env.BRANCH_NAME ==~ /^release\/.*/) ||
                    (env.BRANCH_NAME ==~ /^develop(ment)?$/)
                }
            }
            steps {
                container('node') {
                    dir('jewelry-store') {
                        script {
                            FrontendPipeline.setupNodeEnvironment(this)
                            FrontendPipeline.runLinting(this)
                            FrontendPipeline.runTests(this)
                        }
                    }
                }
            }
            post {
                always {
                    dir('jewelry-store') {
                        junit testResults: 'junit.xml', allowEmptyResults: true
                        publishHTML([
                            allowMissing: true,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: 'coverage/lcov-report',
                            reportFiles: 'index.html',
                            reportName: 'Coverage Report'
                        ])
                    }
                }
            }
        }
        
        stage('Static Analysis') {
            when {
                expression {
                    FrontendPipeline.isPullRequest(env) ||
                    FrontendPipeline.isMainBranch(env) ||
                    (env.BRANCH_NAME ==~ /^feature\/.*/) ||
                    (env.BRANCH_NAME ==~ /^frontend\/.*/) ||
                    (env.BRANCH_NAME ==~ /^patch\/.*/) ||
                    (env.BRANCH_NAME ==~ /^hotfix\/.*/) ||
                    (env.BRANCH_NAME ==~ /^release\/.*/) ||
                    (env.BRANCH_NAME ==~ /^develop(ment)?$/)
                }
            }
            steps {
                container('node') {
                    dir('jewelry-store') {
                        script {
                            FrontendPipeline.runSecurityAudit(this)
                            FrontendPipeline.runBundleAnalysis(this)
                        }
                    }
                }
            }
        }
        
        stage('Build Application') {
            when {
                expression {
                    FrontendPipeline.isPullRequest(env) ||
                    FrontendPipeline.isMainBranch(env) ||
                    (env.BRANCH_NAME ==~ /^feature\/.*/) ||
                    (env.BRANCH_NAME ==~ /^frontend\/.*/) ||
                    (env.BRANCH_NAME ==~ /^patch\/.*/) ||
                    (env.BRANCH_NAME ==~ /^hotfix\/.*/) ||
                    (env.BRANCH_NAME ==~ /^release\/.*/) ||
                    (env.BRANCH_NAME ==~ /^develop(ment)?$/)
                }
            }
            steps {
                container('node') {
                    dir('jewelry-store') {
                        script {
                            FrontendPipeline.buildApplication(this)
                        }
                    }
                }
            }
        }
        
        stage('PR Validation Image Build') {
            when {
                expression { FrontendPipeline.isPullRequest(env) }
            }
            steps {
                container('docker-aws') {
                    dir('jewelry-store') {
                        script {
                            FrontendPipeline.buildValidationImage(
                                this,
                                env,
                                env.ECR_REGISTRY,
                                env.ECR_REPOSITORY
                            )
                        }
                    }
                }
            }
        }
        
        stage('Determine Release Version') {
            when {
                expression { FrontendPipeline.isMainBranch(env) }
            }
            steps {
                script {
                    def releaseVersion = FrontendPipeline.determineReleaseVersion(this, env)
                    env.RELEASE_VERSION = releaseVersion
                    env.RELEASE_TAGS = [
                        "${releaseVersion}-dev",
                        "${releaseVersion}-rc",
                        releaseVersion
                    ].join(',')
                    echo "Release version determined: ${releaseVersion}"
                    echo "Release tags: ${env.RELEASE_TAGS}"
                }
            }
        }
        
        stage('Build Release Image') {
            when {
                expression { FrontendPipeline.isMainBranch(env) }
            }
            steps {
                container('docker-aws') {
                    dir('jewelry-store') {
                        script {
                            def result = FrontendPipeline.buildAndTagReleaseImage(
                                this,
                                env,
                                env.RELEASE_VERSION,
                                env.ECR_REGISTRY,
                                env.ECR_REPOSITORY
                            )
                            env.RELEASE_TEMP_TAG = result.tempTag
                            env.RELEASE_TAGS = result.releaseTags.join(',')
                        }
                    }
                }
            }
        }
        
        stage('Push Release Images') {
            when {
                expression { FrontendPipeline.isMainBranch(env) }
            }
            steps {
                container('docker-aws') {
                    script {
                        def tags = env.RELEASE_TAGS?.split(',')?.collect { it.trim() }?.findAll { it }
                        FrontendPipeline.pushTaggedImages(
                            this,
                            env.ECR_REGISTRY,
                            env.ECR_REPOSITORY,
                            tags,
                            env.AWS_DEFAULT_REGION
                        )
                    }
                }
            }
        }

        // TODO: GitOps manifest updates will be handled in a dedicated CD pipeline.
        // CI intentionally stops after publishing release images.
    }
    
    post {
        always {
            archiveArtifacts artifacts: 'jewelry-store/build/**, jewelry-store/**/*-report.json, jewelry-store/**/junit.xml, jewelry-store/**/coverage/**', allowEmptyArchive: true
            script {
                try {
                    deleteDir()
                } catch (Exception ex) {
                    echo "⚠️ Workspace cleanup skipped: ${ex.message}"
                }
            }
        }
        success {
            echo "✅ Jewelry Store Frontend CI pipeline completed successfully!"
