@Library('shared-pipeline-library@main') _

pipeline {
    agent {
        kubernetes {
            yaml BackendPipeline.getPodTemplate()
        }
    }
    
    environment {
        SERVICE_NAME = 'backend'
        AWS_DEFAULT_REGION = 'us-east-2'
        ECR_REGISTRY = '950555670656.dkr.ecr.us-east-2.amazonaws.com'
        ECR_REPOSITORY = 'jewleryapp/be'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Version Info') {
            when {
                anyOf {
                    changeset "backend/**"
                    triggeredBy cause: "UserIdCause"
                    anyOf {
                        branch 'main'
                        branch 'master'
                    }
                    branch 'backend/PR-*'
                    branch 'PR-*'
                    branch 'backend/release/*'
                    branch 'feature/backend/*'
                    branch 'patch/backend/*'
                    changelog ''
                }
            }
            steps {
                script {
                    // Use Jenkins built-in environment variables
                    def branchName = env.BRANCH_NAME ?: 'unknown'
                    def buildNumber = env.BUILD_NUMBER ?: '0'
                    def commitSha = env.GIT_COMMIT ? env.GIT_COMMIT.take(7) : 'unknown'
                    
                    // Get latest backend version using shared function
                    def latestTag = BackendPipeline.getLatestBackendTag()
                    def hasServiceTags = sh(
                        script: "git tag --list 'backend/v*' | head -n1",
                        returnStdout: true
                    ).trim()
                    
                    // Generate image tag using shared function
                    def imageTag = BackendPipeline.generateImageTag(branchName, latestTag, buildNumber, commitSha)
                    
                    // Set as environment variable for other stages
                    env.IMAGE_TAG = imageTag
                    
                    echo "üè∑Ô∏è  Version Information:"
                    echo "   Service: ${SERVICE_NAME}"
                    echo "   Branch: ${branchName}"
                    echo "   Image Tag: ${imageTag}"
                    echo "   Build Number: ${buildNumber}"
                    echo "   Commit SHA: ${commitSha}"
                    echo "   Latest Service Tag: ${hasServiceTags ? "backend/v${latestTag}" : "None (first release)"}"
                }
            }
        }
        
        stage('Setup Python Environment') {
            when {
                anyOf {
                    changeset "backend/**"
                    triggeredBy cause: "UserIdCause"
                    anyOf {
                        branch 'main'
                        branch 'master'
                    }
                    branch 'backend/PR-*'
                    branch 'PR-*'
                    branch 'backend/release/*'
                    branch 'feature/backend/*'
                    branch 'patch/backend/*'
                    changelog ''
                }
            }
            steps {
                container('python') {
                    dir('backend') {
                        script {
                            BackendPipeline.setupPythonEnvironment()
                        }
                    }
                }
            }
        }
        
        stage('Lint Code') {
            when {
                anyOf {
                    changeset "backend/**"
                    triggeredBy cause: "UserIdCause"
                    anyOf {
                        branch 'main'
                        branch 'master'
                    }
                    branch 'backend/PR-*'
                    branch 'PR-*'
                    branch 'backend/release/*'
                    branch 'feature/backend/*'
                    branch 'patch/backend/*'
                    changelog ''
                }
            }
            steps {
                container('python') {
                    dir('backend') {
                        script {
                            try {
                                BackendPipeline.runLinting()
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è Linting issues found, but continuing pipeline..."
                                echo "Error: ${e.getMessage()}"
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }
        
        stage('Test & Security') {
            when {
                anyOf {
                    changeset "backend/**"
                    triggeredBy cause: "UserIdCause"
                    anyOf {
                        branch 'main'
                        branch 'master'
                    }
                    branch 'backend/PR-*'
                    branch 'PR-*'
                    branch 'backend/release/*'
                    branch 'feature/backend/*'
                    branch 'patch/backend/*'
                    changelog ''
                }
            }
            parallel {
                stage('Run Tests') {
                    steps {
                        container('python') {
                            dir('backend') {
                                script {
                                    BackendPipeline.runTests()
                                }
                            }
                        }
                    }
                    post {
                        always {
                            dir('backend') {
                                junit testResults: 'test-results.xml', allowEmptyResults: true
                                publishHTML([
                                    allowMissing: false,
                                    alwaysLinkToLastBuild: true,
                                    keepAll: true,
                                    reportDir: 'htmlcov',
                                    reportFiles: 'index.html',
                                    reportName: 'Coverage Report'
                                ])
                            }
                        }
                    }
                }
                stage('Security Scan') {
                    steps {
                        container('python') {
                            dir('backend') {
                                script {
                                    BackendPipeline.runSecurityScans()
                                }
                            }
                        }
                    }
                }
            }
        }
        
        
        stage('Build Docker Image') {
            when {
                anyOf {
                    changeset "backend/**"
                    triggeredBy cause: "UserIdCause"
                    anyOf {
                        branch 'main'
                        branch 'master'
                    }
                    branch 'backend/PR-*'
                    branch 'PR-*'
                    branch 'backend/release/*'
                    branch 'feature/backend/*'
                    branch 'patch/backend/*'
                    changelog ''
                }
            }
            steps {
                container('docker-aws') {
                    dir('backend') {
                        script {
                            def additionalTags = BackendPipeline.buildDockerImage(
                                env.IMAGE_TAG, 
                                env.ECR_REGISTRY, 
                                env.ECR_REPOSITORY
                            )
                            env.ADDITIONAL_TAGS = additionalTags.join(',')
                        }
                    }
                }
            }
        }
        
        stage('Push to ECR') {
            when {
                anyOf {
                    changeset "backend/**"
                    triggeredBy cause: "UserIdCause"
                    anyOf {
                        branch 'main'
                        branch 'master'
                    }
                    branch 'backend/release/*'
                    branch 'feature/backend/*'
                    branch 'patch/backend/*'
                }
                not {
                    anyOf {
                        branch 'PR-*'
                        branch 'backend/PR-*'
                    }
                }
            }
            steps {
                container('docker-aws') {
                    dir('backend') {
                        script {
                            def additionalTags = env.ADDITIONAL_TAGS?.split(',') ?: []
                            BackendPipeline.pushToEcr(
                                env.IMAGE_TAG,
                                env.ECR_REGISTRY,
                                env.ECR_REPOSITORY,
                                additionalTags,
                                env.AWS_DEFAULT_REGION
                            )
                        }
                    }
                }
            }
        }
        
        stage('Create Git Tag') {
            when {
                anyOf {
                    anyOf {
                        branch 'main'
                        branch 'master'
                    }
                    branch 'backend/release/*'
                    branch 'release/*'
                }
            }
            steps {
                script {
                    // Check if IMAGE_TAG is available (Version Info stage ran)
                    if (!env.IMAGE_TAG) {
                        echo "‚ÑπÔ∏è  IMAGE_TAG not available, skipping Git tag creation"
                        return
                    }
                    
                    BackendPipeline.createGitTag(env.IMAGE_TAG)
                }
            }
        }
    }
    
    post {
        always {
            archiveArtifacts artifacts: 'backend/**/*-report.json, backend/**/*-results.xml, backend/**/htmlcov/**', allowEmptyArchive: true
        }
        success {
            echo "‚úÖ Backend Service CI pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Backend Service CI pipeline failed!"
        }
    }
}
